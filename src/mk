function vm_modules_install
{
  # Attention: The vm code have to be loaded before this function.
  # Take a look at the beginning of easy-kernel-workflow.sh.
  vm_mount
  set +e
  sudo -E make INSTALL_MOD_PATH=$QEMU_MNT modules_install
  release=$(make kernelrelease)
  say $release
  sudo -E chroot $QEMU_MNT  depmod -a $release
  vm_umount
}

function mk_build
{
  make $MAKE_OPTS
}

function mk_install
{
  # FIXME: validate arch and action
  if [ $TARGET == "arm" ] ; then
    export ARCH=arm CROSS_COMPILE="ccache arm-linux-gnu-"
  fi

  case "$TARGET" in
    qemu)
      vm_modules_install
      ;;
    host)
      sudo -E make modules_install
      sudo -E make install
      ;;
  esac
}

function mk_send_mail
{
  echo -e " * checking git diff...\n"
  git diff
  git diff --cached

  echo -e " * Does it build? Did you test it?\n"
  read
  echo -e " * Are you using the correct subject prefix?\n"
  read
  echo -e " * Did you need/review the cover letter?\n"
  read
  echo -e " * Did you annotate version changes?\n"
  read
  echo -e " * Is git format-patch -M needed?\n"
  read
  echo -e " * Did you review --to --cc?\n"
  read
  echo -e " * dry-run it first!\n"


  SENDLINE="git send-email --dry-run "
  while read line
  do
    SENDLINE+="$line "
  done < emails

  echo $SENDLINE
}

function mk_export_kbuild
{
  say "export KBUILD_OUTPUT=$BUILD_DIR/$TARGET"
  export KBUILD_OUTPUT=$BUILD_DIR/$TARGET
  mkdir -p $KBUILD_OUTPUT
}
